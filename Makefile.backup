# Self-Healing MLOps Pipeline - Makefile
# One-command operations for the entire project

.PHONY: help setup start stop restart clean test lint format verify logs

# Default target
.DEFAULT_GOAL := help

# Colors for output
GREEN  := \033[0;32m
YELLOW := \033[0;33m
RED    := \033[0;31m
NC     := \033[0m # No Color

##@ General

help: ## Display this help message
	@echo "$(GREEN)Self-Healing MLOps Pipeline$(NC)"
	@echo "================================"
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make $(YELLOW)<target>$(NC)\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(GREEN)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Setup & Installation

setup: ## Initial project setup (run once)
	@echo "$(GREEN)Setting up project...$(NC)"
	@mkdir -p data models monitoring/{predictions,reference,metrics,reports,labels}
	@mkdir -p mlflow airflow/logs airflow/plugins
	@echo "$(GREEN)✓ Directories created$(NC)"
	@docker-compose pull
	@echo "$(GREEN)✓ Docker images pulled$(NC)"
	@echo "$(YELLOW)Next steps:$(NC)"
	@echo "  1. Add your dataset to data/cs-training.csv"
	@echo "  2. Run: make bootstrap"
	@echo "  3. Run: make start"

install-dev: ## Install development dependencies
	@echo "$(GREEN)Installing dev dependencies...$(NC)"
	pip install -r requirements.txt
	pip install -r requirements-dev.txt
	pre-commit install
	@echo "$(GREEN)✓ Dev dependencies installed$(NC)"

bootstrap: ## Bootstrap reference data (one-time operation)
	@echo "$(GREEN)Bootstrapping reference data...$(NC)"
	docker-compose up -d mlflow
	@sleep 10
	docker-compose run --rm bootstrap
	@echo "$(GREEN)✓ Reference data created$(NC)"

##@ Docker Operations

start: ## Start all services
	@echo "$(GREEN)Starting all services...$(NC)"
	docker-compose up -d
	@sleep 5
	@make verify

stop: ## Stop all services
	@echo "$(YELLOW)Stopping all services...$(NC)"
	docker-compose stop

restart: ## Restart all services
	@echo "$(YELLOW)Restarting services...$(NC)"
	docker-compose restart

down: ## Stop and remove containers
	@echo "$(RED)Stopping and removing containers...$(NC)"
	docker-compose down

rebuild: ## Rebuild and restart services
	@echo "$(GREEN)Rebuilding services...$(NC)"
	docker-compose up -d --build

##@ Training & Deployment

train: ## Train a new model
	@echo "$(GREEN)Training model...$(NC)"
	docker-compose up -d mlflow
	@sleep 5
	docker-compose up trainer
	@echo "$(GREEN)✓ Training complete$(NC)"
	@echo "$(YELLOW)Remember to promote model to Production in MLflow UI!$(NC)"

promote: ## Promote latest model to Production (interactive)
	@echo "$(YELLOW)Opening MLflow UI for manual promotion...$(NC)"
	@echo "Navigate to: http://localhost:5000"
	@echo "Models → credit-risk-model → Latest version → Transition to Production"
	@open http://localhost:5000 || xdg-open http://localhost:5000 || echo "Visit: http://localhost:5000"

deploy-api: ## Deploy API service
	@echo "$(GREEN)Deploying API...$(NC)"
	docker-compose up -d api
	@sleep 3
	@curl -s http://localhost:8000/health | jq . || echo "API not ready yet"

deploy-monitoring: ## Deploy monitoring service
	@echo "$(GREEN)Deploying monitoring...$(NC)"
	docker-compose up -d monitoring
	@echo "$(GREEN)✓ Monitoring started$(NC)"

##@ Testing & Quality

test: ## Run all tests
	@echo "$(GREEN)Running tests...$(NC)"
	pytest tests/ -v --cov=src --cov-report=term-missing

test-unit: ## Run unit tests only
	@echo "$(GREEN)Running unit tests...$(NC)"
	pytest tests/unit/ -v

test-integration: ## Run integration tests only
	@echo "$(GREEN)Running integration tests...$(NC)"
	pytest tests/integration/ -v

test-coverage: ## Generate HTML coverage report
	@echo "$(GREEN)Generating coverage report...$(NC)"
	pytest --cov=src --cov-report=html
	@echo "$(GREEN)✓ Report generated: htmlcov/index.html$(NC)"
	@open htmlcov/index.html || xdg-open htmlcov/index.html || echo "Open: htmlcov/index.html"

lint: ## Run linting checks
	@echo "$(GREEN)Running linters...$(NC)"
	flake8 src/ tests/ --max-line-length=100 || true
	mypy src/ --ignore-missing-imports || true

format: ## Format code with Black
	@echo "$(GREEN)Formatting code...$(NC)"
	black src/ tests/
	@echo "$(GREEN)✓ Code formatted$(NC)"

format-check: ## Check if code is formatted
	@echo "$(GREEN)Checking code format...$(NC)"
	black --check src/ tests/

quality: format lint test ## Run all quality checks
	@echo "$(GREEN)✓ All quality checks complete$(NC)"

##@ Monitoring & Logs

logs: ## View logs from all services
	docker-compose logs -f

logs-api: ## View API logs
	docker-compose logs -f api

logs-monitoring: ## View monitoring logs
	docker-compose logs -f monitoring

logs-mlflow: ## View MLflow logs
	docker-compose logs -f mlflow

stats: ## Show system statistics
	@echo "$(GREEN)System Statistics$(NC)"
	@echo "=================="
	@echo "Services:"
	@docker-compose ps
	@echo ""
	@echo "Predictions:"
	@curl -s http://localhost:8000/monitoring/stats | jq . || echo "API not available"
	@echo ""
	@echo "Disk usage:"
	@du -sh monitoring/ mlflow/ models/ 2>/dev/null || echo "No data yet"

verify: ## Verify all services are healthy
	@echo "$(GREEN)Verifying services...$(NC)"
	@echo -n "MLflow:     "
	@curl -sf http://localhost:5000/health > /dev/null && echo "$(GREEN)✓$(NC)" || echo "$(RED)✗$(NC)"
	@echo -n "API:        "
	@curl -sf http://localhost:8000/health > /dev/null && echo "$(GREEN)✓$(NC)" || echo "$(RED)✗$(NC)"
	@echo -n "Monitoring: "
	@docker-compose ps monitoring | grep -q "Up" && echo "$(GREEN)✓$(NC)" || echo "$(RED)✗$(NC)"

health: verify ## Alias for verify

##@ Data Operations

generate-predictions: ## Generate test predictions (250 samples)
	@echo "$(GREEN)Generating test predictions...$(NC)"
	@bash scripts/generate_test_predictions.sh 250
	@echo "$(GREEN)✓ Predictions generated$(NC)"

inject-drift: ## Inject drift for testing (requires arg: DRIFT_TYPE)
	@echo "$(YELLOW)Injecting drift: $(DRIFT_TYPE)$(NC)"
	@bash scripts/inject_drift.sh $(DRIFT_TYPE)

clear-predictions: ## Clear prediction logs (CAUTION)
	@echo "$(RED)Clearing prediction logs...$(NC)"
	@read -p "Are you sure? (y/N) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		rm -f monitoring/predictions/predictions.csv; \
		docker-compose restart api; \
		echo "$(GREEN)✓ Predictions cleared$(NC)"; \
	fi

##@ Cleanup

clean-data: ## Remove monitoring data (keeps reference)
	@echo "$(YELLOW)Cleaning monitoring data...$(NC)"
	rm -rf monitoring/predictions/* monitoring/metrics/* monitoring/reports/*
	@echo "$(GREEN)✓ Monitoring data cleaned$(NC)"

clean-models: ## Remove local models
	@echo "$(YELLOW)Cleaning local models...$(NC)"
	rm -rf models/*
	@echo "$(GREEN)✓ Models cleaned$(NC)"

clean-mlflow: ## Remove MLflow data (CAUTION)
	@echo "$(RED)Cleaning MLflow data...$(NC)"
	@read -p "This will delete all experiments! Continue? (y/N) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down; \
		rm -rf mlflow/; \
		echo "$(GREEN)✓ MLflow data cleaned$(NC)"; \
	fi

clean-all: ## Remove all generated data (CAUTION)
	@echo "$(RED)This will delete ALL data!$(NC)"
	@read -p "Continue? (y/N) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose down -v; \
		rm -rf monitoring/ mlflow/ models/; \
		echo "$(RED)✓ All data removed$(NC)"; \
		echo "$(YELLOW)Run 'make setup' to reinitialize$(NC)"; \
	fi

##@ Development

dev-api: ## Run API in development mode
	@echo "$(GREEN)Starting API in dev mode...$(NC)"
	uvicorn src.api_mlflow:app --reload --host 0.0.0.0 --port 8000

dev-monitoring: ## Run monitoring job once (dev)
	@echo "$(GREEN)Running monitoring job...$(NC)"
	python src/monitoring/monitoring_job.py

shell-api: ## Open shell in API container
	docker-compose exec api /bin/bash

shell-monitoring: ## Open shell in monitoring container
	docker-compose exec monitoring /bin/bash

pre-commit: ## Run pre-commit hooks manually
	pre-commit run --all-files

##@ Documentation

docs: ## Open documentation in browser
	@echo "$(GREEN)Opening documentation...$(NC)"
	@open README.md || xdg-open README.md || echo "Open: README.md"

docs-architecture: ## Open architecture docs
	@open docs/architecture.md || xdg-open docs/architecture.md || echo "Open: docs/architecture.md"

mlflow-ui: ## Open MLflow UI
	@open http://localhost:5000 || xdg-open http://localhost:5000 || echo "Visit: http://localhost:5000"

api-docs: ## Open API documentation
	@open http://localhost:8000/docs || xdg-open http://localhost:8000/docs || echo "Visit: http://localhost:8000/docs"

##@ CI/CD

ci-local: ## Run CI pipeline locally
	@echo "$(GREEN)Running CI checks locally...$(NC)"
	@make format-check
	@make lint
	@make test
	@echo "$(GREEN)✓ All CI checks passed$(NC)"

##@ Quick Commands

quick-start: setup bootstrap train start ## Complete setup and start
	@echo "$(GREEN)✓ System ready!$(NC)"
	@echo "$(YELLOW)Next: Promote model to Production$(NC)"
	@make promote

quick-test: generate-predictions verify ## Generate data and verify
	@echo "$(GREEN)✓ Quick test complete$(NC)"
